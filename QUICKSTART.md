# NeuroHome Quick Start Guide

Get NeuroHome running in 5 minutes!

## Prerequisites

Make sure you have these installed:
- Node.js (version 18 or higher)
- npm (version 9 or higher)
- Git

**Optional**:
- Docker Desktop (for running databases)
- PlatformIO (for ESP32 firmware development)

## Step 1: Install Dependencies

```bash
# Clone the repository (when available)
git clone https://github.com/neurohome/neurohome.git
cd neurohome

# Install all dependencies
npm install
```

This will install dependencies for all packages in the monorepo.

## Step 2: Run Tests

Verify everything works:

```bash
npm test
```

You should see all tests passing with >90% coverage.

## Step 3: Build the Project

```bash
npm run build
```

This compiles all TypeScript packages.

## Step 4: Run the Simulator

The simulator creates a virtual smart home for testing:

```bash
npm run simulator:run
```

You'll see output like:

```
Home initialized with 5 devices and 1 users
Starting Home Simulator...
Simulator running. Press Ctrl+C to stop.

[USER] Test User moved to living_room
[SENSOR] Motion detected in living_room
[ACTUATOR] Living Room Light turned on
[SENSOR] Living Room Temperature: 22.3°C

=== HOME STATUS ===

DEVICES:
  Living Room Temperature (living_room): {"temperature":22.3,"unit":"C"}
  Living Room Motion (living_room): {"motion":false}
  Living Room Light (living_room): {"on":true,"brightness":80}
  ...
```

Press `Ctrl+C` to stop the simulator.

## Step 5: Try the Event Processor

Create a test file `test-events.ts`:

```typescript
import { EventProcessor, EventType } from './backend/services/event-processor/src';

const processor = new EventProcessor();

// Register a handler
processor.on(EventType.SENSOR_DATA, async (event) => {
  console.log('Received sensor data:', event.data);
});

// Send some events
processor.addEvent({
  type: EventType.SENSOR_DATA,
  priority: 10,
  data: {
    sensorType: 'temperature',
    value: 22.5,
    unit: 'C'
  }
});

processor.addEvent({
  type: EventType.SENSOR_DATA,
  priority: 5,
  data: {
    sensorType: 'motion',
    value: 1,
    unit: 'bool'
  }
});

// Wait a bit for processing
setTimeout(() => {
  console.log('Metrics:', processor.getMetrics());
  process.exit(0);
}, 1000);
```

Run it:

```bash
npx tsx test-events.ts
```

## Step 6: Test the Rule Engine

Create `test-rules.ts`:

```typescript
import { RuleEngine } from './backend/services/rule-engine/src';

const engine = new RuleEngine();

// Add a temperature alert rule
const ruleId = engine.addRule({
  name: 'High Temperature Alert',
  enabled: true,
  autoGenerated: false,
  priority: 10,
  condition: {
    type: 'simple',
    field: 'temperature',
    operator: 'gt',
    value: 25
  },
  actions: [{
    type: 'notification',
    message: 'Temperature is too high!'
  }]
});

console.log('Rule created:', ruleId);

// Evaluate with normal temperature
let matches = await engine.evaluateRules({
  timestamp: new Date(),
  data: { temperature: 22 }
});

console.log('Matches (22°C):', matches.length); // Should be 0

// Evaluate with high temperature
matches = await engine.evaluateRules({
  timestamp: new Date(),
  data: { temperature: 30 }
});

console.log('Matches (30°C):', matches.length); // Should be 1
console.log('Matched rule:', matches[0].name);

// Execute the rule
await engine.executeRule(ruleId, {
  timestamp: new Date(),
  data: { temperature: 30 }
});

console.log('Execution stats:', engine.getExecutionStats(ruleId));
```

Run it:

```bash
npx tsx test-rules.ts
```

## Step 7: Run Infrastructure (Optional)

If you have Docker installed:

```bash
# Start PostgreSQL, Redis, and RabbitMQ
docker-compose up -d

# Check status
docker-compose ps

# View logs
docker-compose logs -f

# Stop when done
docker-compose down
```

## Step 8: Flash ESP32 Firmware (Optional)

If you have an ESP32 and PlatformIO:

```bash
# Navigate to firmware directory
cd edge/firmware_esp32

# Edit main.cpp to set your WiFi credentials
# Update WIFI_SSID and WIFI_PASSWORD

# Build and flash
pio run -t upload

# Monitor serial output
pio device monitor
```

## Common Commands

```bash
# Development
npm run dev                  # Start all services in dev mode
npm run gateway:dev          # Start API gateway only
npm run dashboard:dev        # Start web dashboard only
npm run simulator:run        # Run home simulator

# Building
npm run build                # Build all packages
npm run build --workspace=@neurohome/event-processor  # Build specific package

# Testing
npm test                     # Run all tests
npm test --workspace=@neurohome/rule-engine  # Test specific package
npm test -- --coverage       # Run with coverage

# Code Quality
npm run lint                 # Lint all code
npm run typecheck            # Type check all packages

# Docker
docker-compose up            # Start infrastructure
docker-compose down          # Stop infrastructure
docker-compose logs -f       # View logs
```

## Project Structure

```
neurohome/
├── backend/                 # Backend services
│   ├── services/
│   │   ├── event-processor/ # Event handling
│   │   ├── rule-engine/     # Automation rules
│   │   └── scene-engine/    # Scene orchestration
│   ├── api/                 # REST API (coming soon)
│   └── gateway/             # API Gateway (coming soon)
├── edge/                    # Edge computing
│   └── firmware_esp32/      # ESP32 firmware
├── tools/                   # Development tools
│   └── sim/                 # Home simulator
├── docs/                    # Documentation
├── README.md                # Project overview
├── ARCHITECTURE.md          # Technical architecture
├── ROADMAP.md               # Development roadmap
├── CONTRIBUTING.md          # Contribution guide
└── MVP_STATUS.md            # Current MVP status
```

## Troubleshooting

### Tests Failing

```bash
# Clear node_modules and reinstall
rm -rf node_modules
npm install

# Clear build cache
rm -rf backend/services/*/dist
npm run build
```

### TypeScript Errors

```bash
# Run type check to see all errors
npm run typecheck

# Make sure you're using Node 18+
node --version
```

### Simulator Not Starting

```bash
# Make sure dependencies are installed
cd tools/sim
npm install

# Try running directly
npx tsx src/index.ts
```

### ESP32 Won't Flash

- Make sure ESP32 is connected via USB
- Install CH340 drivers if needed
- Check port permissions: `sudo chmod 666 /dev/ttyUSB0`
- Try updating PlatformIO: `pio upgrade`

## Next Steps

1. **Read the Documentation**: Check `ARCHITECTURE.md` for system design
2. **Explore the Code**: Start with `backend/services/event-processor/`
3. **Run the Tests**: Learn from the test files
4. **Contribute**: See `CONTRIBUTING.md` for guidelines
5. **Build Something**: Create your first automation rule!

## Getting Help

- **Documentation**: Check the `docs/` folder
- **Issues**: Report bugs and request features
- **Discussions**: Ask questions and share ideas
- **Discord**: Join the community (coming soon)

## Example: Complete Workflow

Here's a complete example showing how all pieces work together:

```typescript
import { EventProcessor, EventType } from './backend/services/event-processor/src';
import { RuleEngine } from './backend/services/rule-engine/src';
import { SceneEngine } from './backend/services/scene-engine/src';

// 1. Create components
const eventProcessor = new EventProcessor();
const ruleEngine = new RuleEngine();
const sceneEngine = new SceneEngine();

// 2. Create a "Relax Mode" scene
const relaxSceneId = sceneEngine.addScene({
  name: 'Relax Mode',
  description: 'Calm lighting and temperature',
  rollbackOnFailure: true,
  actions: [
    { id: '1', deviceId: 'light-1', action: 'dim', value: 0.6, offsetMs: 0 },
    { id: '2', deviceId: 'thermostat', action: 'set', value: 22, offsetMs: 500 }
  ]
});

// 3. Create a rule that triggers the scene
const ruleId = ruleEngine.addRule({
  name: 'Auto Relax When Stressed',
  enabled: true,
  autoGenerated: true,
  priority: 10,
  condition: {
    type: 'simple',
    field: 'emotionalState',
    operator: 'eq',
    value: 'stress'
  },
  actions: [{
    type: 'scene_execution',
    sceneId: relaxSceneId
  }]
});

// 4. Handle events and trigger automation
eventProcessor.on(EventType.EMOTIONAL, async (event) => {
  console.log('Emotional state detected:', event.data);

  // Evaluate rules
  const matches = await ruleEngine.evaluateRules({
    timestamp: event.timestamp,
    data: event.data
  });

  // Execute matched rules
  for (const rule of matches) {
    await ruleEngine.executeRule(rule.id, {
      timestamp: event.timestamp,
      data: event.data
    });
  }
});

// 5. Simulate emotional state change
eventProcessor.addEvent({
  type: EventType.EMOTIONAL,
  priority: 10,
  data: {
    state: 'stress',
    confidence: 0.85,
    factors: { heartRate: 95, movement: 'erratic' }
  }
});

console.log('Automation workflow complete!');
```

---

**You're now ready to start building with NeuroHome!**
